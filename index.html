<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Mats Haugerud</title>
        <link rel="stylesheet" href="style.css">
        <script defer src="app.js"></script>
    </head>
    <body>
        <div id="info">
            <div id="name"></div>
            <div id="text"></div>
            <div id="course"></div>
            <div id="text2"></div>
            <div id="location"></div>
        </div>

        <script type="text/javascript">
            var name, text, location;
            const contents = [["name", "Mats Haugerud "], ["text", "is a "], ["course", "Computer Science "], ["text2", "student at "], ["location", "Aberystwyth University"], ["mst", "Current time on Mars:"], ["rovertime", "01:59:60"]];
            var currentPrint = 0;
            name = "Mats Haugerud";
            text = ' is a\nComputer Science student at\nAberystwyth, Wales';
            var tag = "";
            var canGlitch = false;

            function typing(i, currentTuple){
                id = currentTuple[0];
                thisText = currentTuple[1];
                if(i==0){
                    // console.log("Replacing: ", id);
                    // console.log("Printing ", thisText);
                }
                if(i<thisText.length){
                    let nextChar = thisText.charAt(i);
                    if(nextChar == '\n'){
                        document.getElementById(id).innerHTML += "<br />";
                    }
                    document.getElementById(id).innerHTML += nextChar;
                    
                    i++;
                    setTimeout(typing, Math.floor(Math.random()*100+40), i, currentTuple);
                    
                }  else {
                    // console.log("Exit");
                    currentPrint += 1;
                    if(currentPrint >= contents.length){
                        canGlitch = true;
                        return 1;
                    }
                    typing(0, contents[currentPrint]);
                }
            }
            async function typeInfo(){
                typing(0, contents[currentPrint]);
                i= 0;
            }

            // ******************************************************
            // Char swapping functions
            function randInterval() {
                if(!canGlitch){ // Wait before first time glitching
                    setTimeout(randInterval, rand * 1000);
                } else {
                    var min = 0.1,
                        max = 1;
                    var rand = Math.floor(Math.random() * (max - min + 1) + min); //Generate Random number between 5 - 10
                    var min = 0,
                        max = contents.length-1;
                    var randElement = Math.floor(Math.random() * (max - min + 1) + min); //Generate Random number between 5 - 10
                    var elementToReplace = contents[randElement][0];
                    // console.log("D ",elementToReplace);
                    // console.log('Wait for ' + rand + ' seconds');
                    glitchText(elementToReplace, randElement);
                    setTimeout(randInterval, rand * 1000);
                }
            }

            var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"#¤%&/()=?`\\§|^¨~\'*@£${[]}-_.:,;<>+øæåØÆÅ';
            var charactersLength = characters.length;

            function swapChar(time, charToSwap, char, isWrongChar, elementToReplace, a){
                // console.log("C", elementToReplace)
                let swapDelay = 0.5;
                // swap char
                let info = document.getElementById(elementToReplace);
                let content = info.textContent;
                let outcontent = "";
                if (!isWrongChar){
                    for(let i = 0; i < content.length; i++){
                        let toChar = characters.charAt(Math.floor(Math.random() * charactersLength));
                        outcontent += i == charToSwap ? toChar : content[i];
                    }
                    time -= 1;
                } else {
                    for(let i = 0; i < content.length; i++){
                        outcontent += i == charToSwap ? char : content[i];
                    }
                }
                isWrongChar != isWrongChar;
                // console.log("New: ", outcontent);
                info.textContent = outcontent;
                if (time > 0 || isWrongChar){
                    setTimeout(swapChar, swapDelay, time, charToSwap, char, !isWrongChar, elementToReplace, a);
                } else {
                    info.textContent = contents[a][1];
                }
            }

            function glitchText(elementToReplace, a){
                // console.log("Glitch");
                // How many times to glitch, random
                var min = 1,
                    max = 6;
                let charToSwap = " ";
                let glitchTimes = Math.floor(Math.random() * (max - min + 1) + min)*2;
                // console.log("E", elementToReplace);
                let info = document.getElementById(elementToReplace);
                // console.log("F", info.textContent);
                let char;
                try {
                    // console.log(info.textContent.length);
                    if(info.textContent.length == null){
                        // console.log("Error. Length of content to replace is null");
                        return 0;
                    }
                    do {
                        var min = 0,
                            max = info.textContent.length-1;
                        charToSwap = Math.floor(Math.random() * (max - min + 1) + min);
                        // console.log(charToSwap);
                        char = info.textContent[charToSwap];
                    } while (char == ' ' || char == '\n');
                    // console.log("Gonna swap ", char, " at ", charToSwap, elementToReplace)
                    swapChar(glitchTimes, charToSwap, char, true, elementToReplace, a);
                    // Swap to random char, then swap back
                } catch {
                    // console.log("Error. Failed");
                }
            }

            const positions = {
                "Perseverance": 77.43,
                "InSight": 135.970,
                "Curiosity": 137.42
            }
            const landingsol = {
                "Perseverance": 52304,
                "InSight": 51511,
                "Curiosity": 49268
            }

            function getMarsTime(rover){
                var unixTimestamp = Math.floor(Date.now() / 1000);
                var tai_offset = 37;  // International Atomic Time, leap seconds since 1 January 2017

                var JDutc = unixTimestamp / 86400 + 2440587.5;  // Julian date, UTC
                var JDtt = JDutc + (tai_offset + 32.184) / 86400;  // Julian date in terrestrial time
                var MSD = (JDtt - 2405522.0028779) / 1.0274912517;  // Mars Sol date
                var MTC = (MSD % 1) * 24;

                var lambda_ = 360 - positions[rover];
                var sol = Math.floor(MSD - lambda_ / 360) - landingsol[rover];
                var hours = (MTC - lambda_ * 24 / 360) % 24;
                var minutes = hours % 1 * 60;  // Get fractional part, multiply by 60 to get mins
                var seconds = minutes % 1 * 60;  // Get fractional part, multiply by 60 to get secs

                contents[6][1] = (String(Math.floor(hours)).padStart(2, "0") + ":" + String(Math.floor(minutes)).padStart(2, "0") + ":" + String(Math.floor(seconds)).padStart(2, "0"));
                // console.log(contents[6][1]);
                if(canGlitch){
                    document.getElementById("rovertime").innerHTML = contents[6][1];
                }
                setTimeout(getMarsTime, 1000, rover);
            }

            typeInfo();
            randInterval();
            getMarsTime("Curiosity");
        </script>






        <script>
            var links =[{label: 'link1', bg: '#c0392b', dest: "test.html"}, 
                        {label: 'link2', bg: '#16a085', dest: "test.html"}, 
                        {label: 'link3', bg: '#8e44ad', dest: "test.html"}, 
                        {label: 'link4', bg: '#27ae60', dest: "test.html"}, 
                        {label: 'link5', bg: '#f39c12', dest: "test.html"}, 
                        {label: 'link6', bg: '#2980b9', dest: "test.html"}];

            var radius = 40;
            var windowHeight = window.innerHeight;
            if(windowHeight === 0) {windowHeight = 238;}
            var circleGaps = windowHeight / (links.length+1.5);

            function addLinks() {
                for (var i=0; i<links.length; i++) {
                    link = document.createElement('a'),
                    link.className = "circlebutton";
                    hover = document.createElement('span');
                    link.href = links[i].dest;

                    link.style.color = links[i].bg;
                    link.style.position = 'fixed';
                    link.style.bottom = circleGaps*(i+1)+"px";
                    link.style.right = 100+"px";
                    link.style.zIndex = 100;
                    link.style.width = radius+'px';
                    link.style.height = radius+'px';
                    link.style.backgroundColor = links[i].bg;

                    link.innerHTML = links[i].label;
                    
                    document.body.appendChild(link);
                    document.body.appendChild(hover);
                    link.addEventListener('mouseover', linkOver);
                    link.addEventListener('mouseout', linkOut);
                    links[i].elem = link;
                    links[i].hover = hover;
                }
            }
            function linkOver(e) {
                var thisLink = e.target, thisHover = thisLink.nextSibling;
                thisHover.style.opacity = 1;
                thisLink.style.height = radius*1.5+'px';
                thisLink.style.width = radius*1.5+'px';
            }

            function linkOut(e) {
                var thisLink = e.target, thisHover = thisLink.nextSibling;
                thisLink.style.height = radius+'px';
                thisLink.style.width = radius+"px";
            }

            window.onresize = function() {
                windowHeight = window.innerHeight;
                radius = windowHeight*0.6,
                borderSize = radius*0.021;  
                fontSize = radius*0.12,
                linkSize = radius*0.25;
                circleGaps = windowHeight / (links.length+1);
                // styleCircle();
                // styleLinks();
            }
            // addLinks();
        </script>
        <div id="demos">
            <section class="hidden">
                <div id="mst"></div>
                <div id="rovertime"></div>
            </section>
            <section class="hidden">
                <h1>Hi b</h1>
                <h2>Lorem ipsum bla ad msnkjdnakjnd <br>h blah blah</h2>
            </section>
            <section class="hidden">
                <h1>Hi c</h1>
                <h2>Loremaslkndlakn k ipsum blah blah blah</h2>
            </section>
        </div>
    </body>
</html>